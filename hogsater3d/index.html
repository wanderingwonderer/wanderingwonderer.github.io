<html>
  <head><title>Högsäter 3D</title>
    <script src="./script/babylon.js"></script>
    <script src="./script/babylon.gui.js"></script>
    <script src="./script/babylonjs.loaders.min.js"></script>
    <style>
      body,#renderCanvas { width: 100%; height: 100%; margin:0; padding: 0; overflow:hidden; user-select: none;} 
      body,input { font-family: sans-serif; background-color: #000; color:bisque;}
    </style>
  </head>
  <body>
    <div style="z-index:2;position:absolute;top:30;left:5px;font-size:x-large;text-shadow: 0 0 5px #fee;">
    <input id="yearBox" min-length="0" max-length="4" style="font-size:larger;border: 0 none;width:80px;" value="&nbsp;" />
    <div id="textBox" style="font-size:large;padding-left:6px;">&nbsp;</div>
    </div>
      <canvas id="renderCanvas"></canvas>
    <script>
      const canvas = document.getElementById("renderCanvas");
      const textBox = document.getElementById("textBox");
      const yearBox = document.getElementById("yearBox");
      const engine = new BABYLON.Engine(canvas, true);
  
      let scene, yearSlider, selected, lastSelected;
      let selectedYear = new Date().getFullYear();

      const createScene = function() {
          scene = new BABYLON.Scene(engine);
          scene.clearColor = new BABYLON.Color3.Black;

          BABYLON.SceneLoader.Append("", "hogsater-3d.glb", scene, function (scene) {

            return scene;
          });

          const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, .7, 0), scene);

          // Create slider for selecting year

          var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
          advancedTexture.layer.layerMask = 2;

          var panel = new BABYLON.GUI.StackPanel();
          panel.width = "700px";  //((yearSlider.maximum - yearSlider.minimum) ) + "px";
          panel.fontSize = "14px";
          panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
          panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
          advancedTexture.addControl(panel);

          yearSlider = new BABYLON.GUI.Slider();
          yearSlider.maximum = new Date().getFullYear();
          yearSlider.minimum = 1900;
          yearSlider.height = "24px";
          yearSlider.width = "100%";
          yearSlider.color = "white";
          yearSlider.background = "#333";
          yearSlider.onValueChangedObservable.add(function(value) {
            selectedYear = value.toFixed(0);
            yearBox.value = selectedYear.toString();
            let meshCount = scene.meshes.length;
            for(i=0;i < meshCount; i++) {
              let node = scene.meshes[i].parent;
              if(node) {
                let year = helper.getNodeYear(node);
                if(year) {
                  node.setEnabled(year <= selectedYear);
                }
              }
            }
          });
          yearSlider.value = selectedYear;
          panel.addControl(yearSlider);

          //TODO: Height map
          // CreateGroundFromHeightMap();

          const alpha =  Math.PI/4;
          const beta = Math.PI/3;
          const radius = 700;
          const target = new BABYLON.Vector3(0, 0, 0);
          const camera = new BABYLON.ArcRotateCamera("Camera", alpha, beta, radius, target, scene);
          camera.attachControl(canvas, true);

          scene.onPointerDown = function (evt, pickResult) {
            if (pickResult.hit) {
              lastSelected = selected;
              selected = pickResult.pickedMesh.parent;
              let year = helper.getNodeYear(selected);
              if(lastSelected) {
                lastSelected.getChildMeshes().forEach(m => m.renderOutline = false);
              }
              if(year > 1) {
                selected.getChildMeshes().forEach(m => { m.outlineColor = BABYLON.Color3.Green(); m.outlineWidth=2; m.renderOutline = true});
                textBox.innerHTML = selected.name + ": " + helper.getNodeYear(selected);
              }
              else
              {

              }
            }
          };

          return scene;
      }
  
      const sceneToRender = createScene();
      engine.runRenderLoop(function () {
        sceneToRender.render();
      });

      yearBox.onkeyup = function(e) {
        if(this.value >= yearSlider.minimum && this.value <= yearSlider.maximum) {
          selectedYear = this.value;
          yearSlider.value=selectedYear;
        }
      }
      yearBox.onchange = function(e) {
        this.blur();
      }
      const helper = {
        nodeHasYear: function(n) {
          return n.metadata && n.metadata.gltf.extras && n.metadata.gltf.extras.year
        },
        getNodeYear: function(m) {
          return helper.nodeHasYear(m) ? m.metadata.gltf.extras.year : null;
        }
      }
    </script>
  </body>
</html>